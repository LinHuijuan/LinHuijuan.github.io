(window.webpackJsonp=window.webpackJsonp||[]).push([[15],{520:function(t,s,a){t.exports=a.p+"assets/img/event-loop.33e58a58.jpg"},642:function(t,s,a){t.exports=a.p+"assets/img/event-loop.135ec386.svg"},643:function(t,s,a){t.exports=a.p+"assets/img/perfect-event-loop.809a5ef6.jpg"},644:function(t,s,a){t.exports=a.p+"assets/img/micro-macro-task.209c6e59.jpg"},824:function(t,s,a){"use strict";a.r(s);var n=a(17),e=Object(n.a)({},(function(){var t=this,s=t.$createElement,n=t._self._c||s;return n("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[n("h1",{attrs:{id:"事件循环"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#事件循环"}},[t._v("#")]),t._v(" 事件循环")]),t._v(" "),n("blockquote",[n("p",[t._v("JS自诞生起就是一门单线程的非阻塞的脚本语言。")])]),t._v(" "),n("p",[t._v("参考链接："),n("a",{attrs:{href:"https://mp.weixin.qq.com/s?__biz=MzU0OTExNzYwNg==&mid=2247484473&idx=1&sn=23301fc29f299e85c139cc1a7c597636&chksm=fbb58ff0ccc206e631f2e6a8d9e6e8d376e6265cdbd9042f6ebe9d0150e23231a4b79ed5bcb3&scene=7&key=d23af655a40bb885861839f035a9ee7b75ceadacb1cd0fbe5c9f98d9b8a4f9d6f1e835a6df753bdd8195fc289b233214dad535d411580ba11654835670bd442c763841c474b2cc79332675d27789ad9b&ascene=0&uin=Mjk5Mjc0MDgwNw%3D%3D&devicetype=Windows+10&version=62060833&lang=zh_CN&pass_ticket=y3G7DwjwZt79HJsPz5ZhM1dm%2BqqF62FEQj1h8W9j1B419jIfaLToBqrVZtgyA3AB",target:"_blank",rel:"noopener noreferrer"}},[t._v("事件循环机制的那些事"),n("OutboundLink")],1)]),t._v(" "),n("p",[t._v("[TOC]")]),t._v(" "),n("h2",{attrs:{id:"一、预备概念"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#一、预备概念"}},[t._v("#")]),t._v(" 一、预备概念")]),t._v(" "),n("p",[n("img",{attrs:{src:a(642),alt:"Stack, heap, queue"}})]),t._v(" "),n("h3",{attrs:{id:"_1-1-函数调用形成了一个栈帧"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_1-1-函数调用形成了一个栈帧"}},[t._v("#")]),t._v(" 1.1 函数调用形成了一个栈帧")]),t._v(" "),n("div",{staticClass:"language-js line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-js"}},[n("code",[n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("foo")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("b")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("var")]),t._v(" a "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("10")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" a "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v(" b "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("11")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("bar")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("x")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("var")]),t._v(" y "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("3")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("foo")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("x "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v(" y"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\nconsole"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("bar")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("7")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 返回 42")]),t._v("\n")])]),t._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[t._v("1")]),n("br"),n("span",{staticClass:"line-number"},[t._v("2")]),n("br"),n("span",{staticClass:"line-number"},[t._v("3")]),n("br"),n("span",{staticClass:"line-number"},[t._v("4")]),n("br"),n("span",{staticClass:"line-number"},[t._v("5")]),n("br"),n("span",{staticClass:"line-number"},[t._v("6")]),n("br"),n("span",{staticClass:"line-number"},[t._v("7")]),n("br"),n("span",{staticClass:"line-number"},[t._v("8")]),n("br"),n("span",{staticClass:"line-number"},[t._v("9")]),n("br"),n("span",{staticClass:"line-number"},[t._v("10")]),n("br"),n("span",{staticClass:"line-number"},[t._v("11")]),n("br")])]),n("p",[t._v("当调用 "),n("code",[t._v("bar")]),t._v(" 时，创建了第一个帧 ，帧中包含了 "),n("code",[t._v("bar")]),t._v(" 的参数和局部变量。当 "),n("code",[t._v("bar")]),t._v(" 调用 "),n("code",[t._v("foo")]),t._v(" 时，第二个帧就被创建，并被压到第一个帧之上，帧中包含了 "),n("code",[t._v("foo")]),t._v(" 的参数和局部变量。当 "),n("code",[t._v("foo")]),t._v(" 返回时，最上层的帧就被弹出栈（剩下 "),n("code",[t._v("bar")]),t._v(" 函数的调用帧 ）。当 "),n("code",[t._v("bar")]),t._v(" 返回的时候，栈就空了。")]),t._v(" "),n("h3",{attrs:{id:"_1-2-对象被分配在一个堆中"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_1-2-对象被分配在一个堆中"}},[t._v("#")]),t._v(" 1.2 对象被分配在一个堆中")]),t._v(" "),n("p",[t._v("堆，即用以表示一大块非结构化的内存区域。")]),t._v(" "),n("h3",{attrs:{id:"_1-3-一个待处理的消息队列"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_1-3-一个待处理的消息队列"}},[t._v("#")]),t._v(" 1.3 一个待处理的消息队列")]),t._v(" "),n("p",[t._v("一个 JavaScript 运行时包含了一个待处理的消息队列。每一个消息都关联着一个用以处理这个消息的函数。")]),t._v(" "),n("p",[t._v("在事件循环期间的某个时刻，运行时从最先进入队列的消息开始处理队列中的消息。为此，这个消息会被移出队列，并作为输入参数调用与之关联的函数。正如前面所提到的，调用一个函数总是会为其创造一个新的栈帧。")]),t._v(" "),n("p",[t._v("函数的处理会一直进行到执行栈再次为空为止；然后事件循环将会处理队列中的下一个消息（如果还有的话）。")]),t._v(" "),n("ul",[n("li",[t._v("执行至完成")])]),t._v(" "),n("p",[t._v("每一个消息完整的执行后，其它消息才会被执行。这为程序的分析提供了一些优秀的特性，包括：一个函数执行时，它永远不会被抢占，并且在其他代码运行之前完全运行（且可以修改此函数操作的数据）。")]),t._v(" "),n("p",[t._v("这个模型的一个缺点在于当一个消息需要太长时间才能处理完毕时，Web应用就无法处理用户的交互，例如点击或滚动。浏览器用“程序需要过长时间运行”的对话框来缓解这个问题。一个很好的做法是缩短消息处理，并在可能的情况下将一个消息裁剪成多个消息。")]),t._v(" "),n("h3",{attrs:{id:"_1-4-单线程"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_1-4-单线程"}},[t._v("#")]),t._v(" 1.4 单线程")]),t._v(" "),n("h4",{attrs:{id:"_1-4-1-理解单线程"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_1-4-1-理解单线程"}},[t._v("#")]),t._v(" 1.4.1 理解单线程")]),t._v(" "),n("ul",[n("li",[n("p",[t._v("JS的单线程并不是指整个JS引擎只有1个线程，而是指运行代码只有1个线程，但是它还有其他线程来执行其他任务。比如时间函数的计时、AJAX技术中的和后台交互等操作。")])]),t._v(" "),n("li",[n("p",[t._v("所以，实际情况应该是：JS引擎中执行代码的线程开始运行代码，当执行到异步方法时，把异步的回调方法放入到队列中，然后由专门计时的线程开始计时。代码线程继续运行。如果计时的时间已到，那么它会通知代码线程来执行队列中对应的回调函数。当然前提是代码线程已经把同步代码执行完后，否则需要继续等待。")])])]),t._v(" "),n("h4",{attrs:{id:"_1-4-2-单线程的弱点"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_1-4-2-单线程的弱点"}},[t._v("#")]),t._v(" 1.4.2 单线程的弱点")]),t._v(" "),n("ol",[n("li",[t._v("无法利用多核CPU。")]),t._v(" "),n("li",[t._v("错误会引起整个应用退出，应用的健壮性值的考验。")]),t._v(" "),n("li",[t._v("大量计算占用CPU导致无法继续调用异步I/O。")])]),t._v(" "),n("h2",{attrs:{id:"二、事件循环"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#二、事件循环"}},[t._v("#")]),t._v(" 二、事件循环")]),t._v(" "),n("blockquote",[n("ul",[n("li",[n("strong",[t._v("从全局任务 "),n("code",[t._v("script")]),t._v("开始，任务依次进入栈中，被主线程执行，执行完后出栈。")])]),t._v(" "),n("li",[t._v("遇到异步任务，交给异步处理模块处理，对应的异步处理线程处理异步任务需要的操作，例如定时器的计数和异步请求监听状态的变更。")]),t._v(" "),n("li",[t._v("当异步任务达到可执行状态时，事件触发线程将回调函数加入任务队列，等待栈为空时，依次进入栈中执行。")])])]),t._v(" "),n("blockquote",[n("p",[n("strong",[t._v("先微后宏。")])]),t._v(" "),n("ul",[n("li",[t._v("由于执行代码入口都是全局任务 "),n("code",[t._v("script")]),t._v("，而全局任务属于宏任务，所以当栈为空，同步任务任务执行完毕时，会先执行微任务队列里的任务。")]),t._v(" "),n("li",[t._v("微任务队列里的任务全部执行完毕后，会读取宏任务队列中排最前的任务。")]),t._v(" "),n("li",[t._v("执行宏任务的过程中，遇到微任务，依次加入微任务队列。")]),t._v(" "),n("li",[t._v("栈空后，再次读取微任务队列里的任务，依次类推。")])])]),t._v(" "),n("p",[n("img",{attrs:{src:a(643),alt:"perfect-event-ioop"}})]),t._v(" "),n("ul",[n("li",[n("strong",[t._v("栈")]),t._v(" 就像是一个容器，任务都是在栈中执行。")]),t._v(" "),n("li",[n("strong",[t._v("主线程")]),t._v(" 就像是操作员，负责执行栈中的任务。")]),t._v(" "),n("li",[n("strong",[t._v("任务队列")]),t._v(" 就像是等待被加工的物品。")]),t._v(" "),n("li",[t._v("异步任务完成注册后会将回调函数加入任务队列等待主线程执行。")]),t._v(" "),n("li",[t._v("执行栈中的同步任务执行完毕后，会查看并读取任务队列中的事件函数，于是任务队列的函数结束等待状态，进入执行栈，开始执行。")])]),t._v(" "),n("p",[n("img",{attrs:{src:a(520),alt:"event-loop"}})]),t._v(" "),n("p",[t._v("之所以称之为事件循环，是因为它经常按照类似如下的方式来被实现：")]),t._v(" "),n("div",{staticClass:"language-js line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-js"}},[n("code",[n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("while")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("queue"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("waitForMessage")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    queue"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("processNextMessage")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[t._v("1")]),n("br"),n("span",{staticClass:"line-number"},[t._v("2")]),n("br"),n("span",{staticClass:"line-number"},[t._v("3")]),n("br")])]),n("p",[t._v("如果当前没有任何消息，"),n("code",[t._v("queue.waitForMessage()")]),t._v(" 会同步地等待消息到达。")]),t._v(" "),n("ul",[n("li",[t._v("用户交互、IO 和定时器会向事件队列中加入事件。")]),t._v(" "),n("li",[t._v("并发是指两个或多个事件链随时间发展交替执行，以至于从更高的层次来看，就像是同时\n在运行（尽管在任意时刻只处理一个事件）。")])]),t._v(" "),n("h3",{attrs:{id:"_2-1-settimeout"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_2-1-settimeout"}},[t._v("#")]),t._v(" 2.1 setTimeout")]),t._v(" "),n("ul",[n("li",[t._v("函数 "),n("code",[t._v("setTimeout")]),t._v("接受两个参数：待加入队列的消息和一个延迟（可选，默认为 0）。")]),t._v(" "),n("li",[t._v("这个延迟代表了消息被实际加入到队列的最小延迟时间。如果队列中没有其它消息，在这段延迟时间过去之后，消息会被马上处理。")]),t._v(" "),n("li",[t._v("但是，如果有其它消息，"),n("code",[t._v("setTimeout")]),t._v(" 消息必须等待其它消息处理完。因此"),n("strong",[t._v("第二个参数仅仅表示最少延迟时间，而非确切的等待时间")]),t._v("。")])]),t._v(" "),n("div",{staticClass:"language-js line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-js"}},[n("code",[n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function-variable function"}},[t._v("foo")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" console"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"First"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function-variable function"}},[t._v("bar")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("setTimeout")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" console"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Second"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function-variable function"}},[t._v("baz")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" console"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Third"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("bar")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("foo")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("baz")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// First Third Second")]),t._v("\n")])]),t._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[t._v("1")]),n("br"),n("span",{staticClass:"line-number"},[t._v("2")]),n("br"),n("span",{staticClass:"line-number"},[t._v("3")]),n("br"),n("span",{staticClass:"line-number"},[t._v("4")]),n("br"),n("span",{staticClass:"line-number"},[t._v("5")]),n("br"),n("span",{staticClass:"line-number"},[t._v("6")]),n("br"),n("span",{staticClass:"line-number"},[t._v("7")]),n("br"),n("span",{staticClass:"line-number"},[t._v("8")]),n("br")])]),n("h3",{attrs:{id:"_2-2-常见异步操作"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_2-2-常见异步操作"}},[t._v("#")]),t._v(" 2.2 常见异步操作")]),t._v(" "),n("ul",[n("li",[n("p",[t._v("Ajax")])]),t._v(" "),n("li",[n("p",[t._v("DOM的事件操作")])]),t._v(" "),n("li",[n("p",[t._v("setTimeout")])]),t._v(" "),n("li",[n("p",[t._v("Promise的then方法")])]),t._v(" "),n("li",[n("p",[t._v("Node的读取文件")])])]),t._v(" "),n("h3",{attrs:{id:"_2-3-任务"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_2-3-任务"}},[t._v("#")]),t._v(" 2.3 任务")]),t._v(" "),n("p",[t._v("采纳 JSC 引擎的术语，我们把宿主发起的任务称为宏观任务，把 JavaScript 引擎发起的任务称为微观任务。")]),t._v(" "),n("h4",{attrs:{id:"_2-3-1-宏任务-macrotask"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_2-3-1-宏任务-macrotask"}},[t._v("#")]),t._v(" 2.3.1 宏任务 （macrotask）")]),t._v(" "),n("p",[n("code",[t._v("script(全局任务)")]),t._v("， "),n("code",[t._v("setTimeout")]),t._v("， "),n("code",[t._v("setInterval")]),t._v("， "),n("code",[t._v("setImmediate")]),t._v("， "),n("code",[t._v("I/O")]),t._v("， "),n("code",[t._v("UI rendering")]),t._v("，"),n("code",[t._v("script(整体代码)")])]),t._v(" "),n("h4",{attrs:{id:"_2-3-2-微任务-microtask"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_2-3-2-微任务-microtask"}},[t._v("#")]),t._v(" 2.3.2 微任务（microtask）")]),t._v(" "),n("p",[n("code",[t._v("process.nextTick")]),t._v("， "),n("code",[t._v("Promise.then()")]),t._v("， "),n("code",[t._v("Object.observe")]),t._v("， "),n("code",[t._v("MutationObserver")]),t._v("，"),n("code",[t._v("Promise")])]),t._v(" "),n("p",[n("strong",[t._v("在微任务中 process.nextTick 优先级高于Promise")])]),t._v(" "),n("ul",[n("li",[t._v("如果是宏任务，则新增一个宏任务队列，任务队列中的宏任务可以有多个来源。")]),t._v(" "),n("li",[t._v("如果是微任务，则直接压入微任务队列。")])]),t._v(" "),n("p",[n("img",{attrs:{src:a(644),alt:"异步任务"}})]),t._v(" "),n("ul",[n("li",[n("p",[t._v("Event loop过程：将一个macro-task执行并出队；将一队micro-task执行并出队；执行渲染操作，更新界面；处理worker相关的任务。")])]),t._v(" "),n("li",[n("p",[t._v("渲染时机：在异步任务中实现DOM修改时，应该将其包装成micro任务。")])])]),t._v(" "),n("div",{staticClass:"language-js line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-js"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// task 是一个用于修改DOM的回调")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("setTimeout")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("task"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 因为script是一个macro任务，所以执行完script就要去处理micro队列，接着就是render；然后本次render并没有执行task，所以没有渲染DOM。")]),t._v("\n\nPromise"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("resolve")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("then")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("task"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 不用再等待一轮事件循环，就可以为用户呈现最及时的渲染结果。")]),t._v("\n")])]),t._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[t._v("1")]),n("br"),n("span",{staticClass:"line-number"},[t._v("2")]),n("br"),n("span",{staticClass:"line-number"},[t._v("3")]),n("br"),n("span",{staticClass:"line-number"},[t._v("4")]),n("br"),n("span",{staticClass:"line-number"},[t._v("5")]),n("br"),n("span",{staticClass:"line-number"},[t._v("6")]),n("br")])])])}),[],!1,null,null,null);s.default=e.exports}}]);
(window.webpackJsonp=window.webpackJsonp||[]).push([[207],{873:function(t,s,a){"use strict";a.r(s);var r=a(17),e=Object(r.a)({},(function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[a("h1",{attrs:{id:"异常监控"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#异常监控"}},[t._v("#")]),t._v(" 异常监控")]),t._v(" "),a("blockquote",[a("p",[t._v("参考教程："),a("a",{attrs:{href:"https://juejin.im/post/5b5dcfb46fb9a04f8f37afbb",target:"_blank",rel:"noopener noreferrer"}},[t._v("前端性能与异常上报"),a("OutboundLink")],1)])]),t._v(" "),a("p",[t._v("[TOC]")]),t._v(" "),a("h2",{attrs:{id:"一、异常捕获"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#一、异常捕获"}},[t._v("#")]),t._v(" 一、异常捕获")]),t._v(" "),a("h3",{attrs:{id:"_1-1-全局捕获"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-1-全局捕获"}},[t._v("#")]),t._v(" 1.1 全局捕获")]),t._v(" "),a("h4",{attrs:{id:"_1-1-1-window-onerror-dom0"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-1-1-window-onerror-dom0"}},[t._v("#")]),t._v(" 1.1.1 "),a("code",[t._v("window.onerror")]),t._v("(DOM0)")]),t._v(" "),a("ul",[a("li",[t._v("当"),a("strong",[t._v("JavaScript运行时错误")]),t._v("（包括语法错误）发生时，"),a("code",[t._v("window")]),t._v("会触发一个"),a("code",[t._v("ErrorEvent")]),t._v("接口的"),a("code",[t._v("error")]),t._v("事件，并执行"),a("code",[t._v("window.onerror()")]),t._v("。")])]),t._v(" "),a("div",{staticClass:"language-js line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[t._v("window"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function-variable function"}},[t._v("onerror")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("message"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" source"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" lineno"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" colno"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" error")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("...")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br")])]),a("ol",[a("li",[a("code",[t._v("message")]),t._v("：错误信息（字符串）。可用于HTML "),a("code",[t._v('onerror=""')]),t._v("处理程序中的"),a("code",[t._v("event")]),t._v("。")]),t._v(" "),a("li",[a("code",[t._v("source")]),t._v("：发生错误的脚本URL（字符串）")]),t._v(" "),a("li",[a("code",[t._v("lineno")]),t._v("：发生错误的行号（数字）")]),t._v(" "),a("li",[a("code",[t._v("colno")]),t._v("：发生错误的列号（数字）")]),t._v(" "),a("li",[a("code",[t._v("error")]),t._v("：[Error对象]（对象）"),a("code",[t._v("new Error([message[, fileName[, lineNumber]]])")])]),t._v(" "),a("li",[t._v("若该函数返回"),a("code",[t._v("true")]),t._v("，则阻止执行默认事件处理函数。")])]),t._v(" "),a("ul",[a("li",[t._v("不足之处\n"),a("ul",[a("li",[t._v("无法捕获资源加载错误，原因是："),a("strong",[t._v("资源加载错误，并不会向上冒泡，object.onerror捕获后就会终止（不会冒泡给window）。")])]),t._v(" "),a("li",[t._v("无法捕获"),a("strong",[t._v("跨域")]),t._v("的js运行错误。跨域之后"),a("code",[t._v("window.onerror")]),t._v("根本捕获不到正确的异常信息，而是统一返回一个"),a("code",[t._v("Script error")]),t._v("。")])])])]),t._v(" "),a("h4",{attrs:{id:"_1-1-2-window-addeventlistener-error-fn"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-1-2-window-addeventlistener-error-fn"}},[t._v("#")]),t._v(" 1.1.2 "),a("code",[t._v('window.addEventListener("error", fn)')])]),t._v(" "),a("h3",{attrs:{id:"_1-2-跨域js捕获"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-2-跨域js捕获"}},[t._v("#")]),t._v(" 1.2 跨域JS捕获")]),t._v(" "),a("p",[t._v("在window.onerror基础之上，做如下操作：")]),t._v(" "),a("ol",[a("li",[t._v("服务端：设置js资源响应头Acess-Control-Allow-Origin:*")])]),t._v(" "),a("p",[t._v("在"),a("code",[t._v("b.js")]),t._v("文件里，加入如下 response header，表示允许跨域：（或者直接给静态资源"),a("code",[t._v("b.js")]),t._v("加这个 response header）")]),t._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("Access-Control-Allow-Origin: *\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br")])]),a("ol",{attrs:{start:"2"}},[a("li",[t._v("客户端：在script标签添加crossorigin属性。")])]),t._v(" "),a("p",[t._v("引入第三方的文件"),a("code",[t._v("b.js")]),t._v("时，在"),a("code",[t._v("<script>")]),t._v("标签中增加"),a("code",[t._v("crossorigin")]),t._v("属性。")]),t._v(" "),a("div",{staticClass:"language-js line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("script src"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"http://cdn.xxx.com/index.js"')]),t._v(" crossorigin"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"anonymous"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("script"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br")])]),a("h3",{attrs:{id:"_1-3-资源加载错误捕获"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-3-资源加载错误捕获"}},[t._v("#")]),t._v(" 1.3 资源加载错误捕获")]),t._v(" "),a("h4",{attrs:{id:"_1-3-1-object-onerror"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-3-1-object-onerror"}},[t._v("#")]),t._v(" 1.3.1 object.onerror")]),t._v(" "),a("p",[t._v("img标签、script标签等节点都可以添加onerror事件，用来捕获资源加载的错误。")]),t._v(" "),a("h4",{attrs:{id:"_1-3-2-performance-getentries-间接捕获"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-3-2-performance-getentries-间接捕获"}},[t._v("#")]),t._v(" 1.3.2 performance.getEntries（间接捕获）")]),t._v(" "),a("p",[t._v("可以获取所有已加载资源的加载时长，通过这种方式，可以间接的拿到没有加载的资源错误。")]),t._v(" "),a("p",[t._v("举例：")]),t._v(" "),a("p",[t._v("浏览器打开一个网站，在Console控制台下，输入：")]),t._v(" "),a("div",{staticClass:"language-js line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[t._v("performance"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("getEntries")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("forEach")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("item")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("console"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("item"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("name"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br")])]),a("p",[t._v("或者输入：")]),t._v(" "),a("div",{staticClass:"language-js line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[t._v("performance"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("getEntries")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("forEach")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("item")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("console"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("item"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("name"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br")])]),a("p",[t._v("上面这个api，返回的是数组。打印出来的资源就是"),a("strong",[t._v("已经成功加载")]),t._v("的资源。")]),t._v(" "),a("p",[t._v("再输入"),a("code",[t._v("document.getElementsByTagName('img')")]),t._v("，就会显示出所有"),a("strong",[t._v("需要加载")]),t._v("的的img集合。")]),t._v(" "),a("p",[t._v("于是，"),a("code",[t._v("document.getElementsByTagName('img')")]),t._v("获取的资源数组减去通过"),a("code",[t._v("performance.getEntries()")]),t._v("获取的资源数组，剩下的就是没有成功加载的，间接捕获到资源加载错误。")]),t._v(" "),a("h4",{attrs:{id:"_1-3-3-error事件捕获"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-3-3-error事件捕获"}},[t._v("#")]),t._v(" 1.3.3 Error事件捕获")]),t._v(" "),a("p",[t._v("资源源加载错误，虽然会阻止冒泡，但是不会阻止捕获。我们可以在捕获阶段绑定error事件。")]),t._v(" "),a("h2",{attrs:{id:"二、性能监控"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#二、性能监控"}},[t._v("#")]),t._v(" 二、性能监控")]),t._v(" "),a("h2",{attrs:{id:"三、日志上报"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#三、日志上报"}},[t._v("#")]),t._v(" 三、日志上报")])])}),[],!1,null,null,null);s.default=e.exports}}]);